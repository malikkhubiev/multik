# Миграция на новую архитектуру проекта

## Обзор изменений

Проект переходит с архитектуры множественных ботов на архитектуру с двумя ботами:

1. **Settings Bot** - для управления проектами (создание, настройка, удаление)
2. **Main Bot** - единый бот для ответов от имени всех проектов

## Основные изменения

### База данных
- Убрано поле `token` из таблицы `Project`
- Добавлено поле `welcome_message` для настройки приветственного сообщения
- Добавлено поле `bot_link` с уникальной ссылкой на бота

### Создание проекта
- Больше не требуется токен Telegram бота
- Автоматически генерируется уникальная ссылка с `projectId`
- Упрощен процесс создания - только название и бизнес-информация

### Работа бота
- Все клиенты используют одну ссылку на единого бота
- Бот определяет проект по параметру `projectId` в ссылке
- Бот отвечает от имени бизнеса, указанного в проекте

## Инструкции по миграции

### 1. Подготовка окружения

Создайте файл `.env` со следующими переменными:

```bash
# Основные настройки сервера
SERVER_URL=https://your-domain.com
PORT=8000

# База данных
DATABASE_URL=sqlite+aiosqlite:///bot_database.db

# Основной бот для ответов от имени проектов
MAIN_BOT_TOKEN=your_main_bot_token_here
MAIN_BOT_USERNAME=your_main_bot_username

# Settings бот для управления проектами
SETTINGS_BOT_TOKEN=your_settings_bot_token_here

# API ключи
DEEPSEEK_API_KEY=your_deepseek_api_key_here

# Настройки платежей
TRIAL_DAYS=10
TRIAL_PROJECTS=3
PAID_PROJECTS=5
PAYMENT_AMOUNT=5000
DISCOUNT_PAYMENT_AMOUNT=2500
PAYMENT_CARD_NUMBER1=1234567890123456
PAYMENT_CARD_NUMBER2=1234567890123457
PAYMENT_CARD_NUMBER3=1234567890123458

# Администратор
MAIN_TELEGRAM_ID=123456789

# Google Sheets Analytics (опционально)
GOOGLE_SHEETS_WEBHOOK_URL=your_google_sheets_webhook_url
```

### 2. Создание ботов

#### Main Bot (для ответов от имени проектов)
1. Создайте бота через @BotFather
2. Получите токен и username
3. Добавьте в `.env`:
   - `MAIN_BOT_TOKEN`
   - `MAIN_BOT_USERNAME`

#### Settings Bot (для управления проектами)
1. Создайте второго бота через @BotFather
2. Получите токен
3. Добавьте в `.env`:
   - `SETTINGS_BOT_TOKEN`

### 3. Запуск миграции

```bash
python migrate_database.py
```

Скрипт автоматически:
- Создаст новую структуру таблицы `Project`
- Перенесет существующие данные
- Сгенерирует уникальные ссылки для всех проектов
- Удалит старые токены

### 4. Запуск сервера

```bash
python server.py
```

## Новая архитектура

### Создание проекта
1. Пользователь отправляет `/start` в Settings Bot
2. Вводит название проекта
3. Отправляет информацию о бизнесе
4. Получает уникальную ссылку на Main Bot

### Использование бота клиентами
1. Клиент переходит по ссылке вида: `https://t.me/your_bot?start=proj{projectId}`
2. Main Bot автоматически определяет проект по `projectId`
3. Бот отвечает от имени бизнеса, используя бизнес-информацию из проекта

### Настройка приветственного сообщения
- Используйте команду `/settings` в Settings Bot
- Выберите проект
- Настройте приветственное сообщение

## Проверка работы

### После миграции проверьте:
1. ✅ Создание проекта без токена
2. ✅ Генерация уникальной ссылки
3. ✅ Работа Main Bot по ссылке с `projectId`
4. ✅ Ответы от имени бизнеса
5. ✅ Работа форм
6. ✅ Проверка доступности проекта (trial/paid)

### Логи
Следите за логами:
- `[MAIN_BOT]` - логи основного бота
- `[SETTINGS_BOT]` - логи бота настроек
- `[DB]` - логи базы данных

## Возможные проблемы

### Ошибка "Проект не найден"
- Проверьте, что миграция выполнена успешно
- Убедитесь, что `projectId` в ссылке корректный

### Бот не отвечает
- Проверьте webhook настройки
- Убедитесь, что оба бота запущены
- Проверьте токены в `.env`

### Ошибки базы данных
- Проверьте права доступа к файлу БД
- Убедитесь, что миграция завершена без ошибок

## Откат изменений

Если нужно откатить изменения:
1. Остановите сервер
2. Восстановите резервную копию БД
3. Верните старые версии файлов из git

## Поддержка

При возникновении проблем:
1. Проверьте логи сервера
2. Убедитесь в корректности `.env`
3. Проверьте статус ботов через @BotFather
4. Создайте issue с описанием проблемы
